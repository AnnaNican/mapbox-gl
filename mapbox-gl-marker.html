<link rel="import" href="../polymer/polymer.html">

<!--
The `mapbox-gl-marker` element represents a map marker. It is used as a
child of `mapbox-gl`.

The default anchor is the CENTER of the element.

You can either style the element via CSS selector "div.mapbox-gl-marker", or attached other elements as its
child as shown in the example below.

<b>Example</b>:
```html
<mapbox-gl id="map"
  interactive
  map="{{map}}"
  map-style="mapbox://styles/mapbox/dark-v9"
  access-token="<MAPBOX_ACCESS_TOKEN>"
  latitude=1.3521
  longitude=103.8698
  zoom=16
  pitch=45
  bearing=0>

    <mapbox-gl-marker class="big_kitten"
      latitude=1.3521 longitude=103.8698>
    </mapbox-gl-marker>

    <mapbox-gl-marker
      latitude=1.3541 longitude=103.8718
      offset-top=15>
      <div class="textbox">Some text here</div>
      <div class="arrow-down"></div>
    </mapbox-gl-marker>

</mapbox-gl>
```

See https://www.mapbox.com/mapbox-gl-js/api/#Marker for
more details.

@demo demo/index.html
-->

<dom-module id="mapbox-gl-marker">
  <template>
    <style>
      :host {
        display: block;
        padding: 0;
      }
    </style>
    <content></content>
  </template>
  <script>
    Polymer({

      is: 'mapbox-gl-marker',
      properties: {
        height: {
          type: Number,
          value: 24
        },
        width: {
          type: Number,
          value: 24
        },
        /*
         * latitude of the marker
         */
        latitude: {
          type: Number
        },
        /*
         * longitude of the marker
         */
        longitude: {
          type: Number
        },
        /*
         * POSTIVE values denotes the number of pixels to offset to the RIGHT,
         * while NEGATIVE values denotes the number of pixels to offset to the
         * LEFT.
         *
         * Equivalent to CSS left.
         */
        offsetLeft: {
          type: Number,
          value: 0
        },
        /*
         * POSTIVE values denotes the number of pixels to offset DOWNWARD,
         * while NEGATIVE values denotes the number of pixels to offset UPWARD.
         *
         * Equivalent to CSS top.
         */
        offsetTop: {
          type: Number,
          value: 0
        },
        /*
         * `map` object returned from mapbox-gl
         */
        map: {
          type: Object
        },
        /*
         * 'mapboxgl.Marker' object
         */
        marker: {
          type: Object,
          notify: true,
          readonly: true
        },

        _attached: Boolean
      },

      observers: [
        '_createMarker(map, latitude, longitude, offsetLeft, offsetTop)',
        'updateLatLng(marker, latitude, longitude)'
      ],

      attached: function() {
        this._attached = true;
      },

      detached: function() {
        this._attached = false;
        console.log('remove')
        console.log(this.marker)
        if (this.marker) {
          this.marker.remove();
        }
      },

      /*
       * Updates the latitude and longitude of the marker
       */
      updateLatLng: function(marker, lat, lng) {
        if (marker) {
          marker.setLngLat([lng, lat]);
        }
      },

      _createMarker: function(map, lat, lng, offsetLeft, offsetTop) {
        var children = Array.prototype.slice.call(this.children);
        var len = children.length;
        var className = ('mapbox-gl-marker '+this.className).trim();
        var ele;
        if (len == 0) {
          ele = document.createElement('div');
          ele.className = className;
        }
        if (len == 1) {
          ele = children[0];
        } else {
          // if more than 1 ele, create a wrapper
          ele = document.createElement('div');
          ele.className = className;
          for (var i=0; i<len; ++i) {
            ele.appendChild(children[i]);
          }
        }

        this.marker = new mapboxgl.Marker(ele, {offset: [offsetLeft, offsetTop]})
                                  .setLngLat([lng, lat])
                                  .addTo(map);
      }

    });
  </script>
</dom-module>
